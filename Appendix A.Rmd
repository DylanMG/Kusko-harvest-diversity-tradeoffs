---
title: 'Appendix A: Stationary Ricker to cyclical Beveton-Holt spawner-recruit formulation'
author: "B. Connors"
date: "July 23, 2019"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("load.R")
```

In our baseline simulations we assumed that recruitment dynamics are governed by stationary spawner-recruitment dynamics that follow a Ricker-type relationship with overcompensation at high spawner abundances (equations 1-3). This is the state of nature that is currently assumed by fishery managers in the Kuskokwim and widely across other salmon fisheries. We also considered an alternative recruitment hypothesis that assumed that low frequency regime shifts occur that gave rise to the appearance of overcompensation, when in fact none was present. Under this hypothesis we assumed that individual spawner-recruitment relationships were governed by Beverton-Holt dynamics with cyclical variation in population productivity (hereafter referred to as "BH_cycl"). This appendix details simulations used to parameterize the BH_cycl formulation in a manner that maintains the general system characteristics of the Kuskokwim. 

In additon to the terms in equations 1-3 there are three additoanl terms required to parameterize the BH_cyl formulation: f and A which are the period and amplitude of time varying productivity, repsecitively, and ?? which is a scalar that adjusts productivity such that long-term population equilibrium abundance in the absence of fishing is approximately the same as those under the stationary Ricker spawner-recruitment formulation.

Here is an example of a spawner-recruit relationships generated by equation 6 with F = 12, A = 0.4 and ?? = 1

```{r ,include=FALSE}
# simulate a spawner-recruitment relationship assuming BH_cyl based on a draw from the posteriors of the model fit (and median alpha and beta)

		draw <- sample(10000,1)
    #draw <-  6606
    
sim_1 <- process(ny = 50,
        vcov.matrix = process.iteration(samps[draw,])$Sigma_R,
        phi = process.iteration(samps[draw,])$phi,
        mat = process.iteration(samps[draw,])$pis,
        alpha = colMedians(samps)[1:13],
        beta = colMedians(samps)[14:26],
        sub = 10000,
        com = 0,
        egfloor = 10000,
        pm.yr = 0,
        for.error = 0.1,
        OU = 0,
        Rec = process.iteration(samps[draw,])$R,
        Spw = process.iteration(samps[draw,])$S,
        lst.resid = process.iteration(samps[draw,])$last_resid,
        SR_rel = "Beverton-Holt",
        BH.alpha.CV = 0.4,
        period = 12,
        dir.SR = "F",
        SR_devs <- array(1,dim=c(ny,2,13)),
        expan = 1)

spawners <- rowSums(sim_1$S)[10:50]
recruits <- rowSums(sim_1$R)[10:50]

BH_prod_col <- viridis(6)

time_prod_col <- c(BH_prod_col[2],BH_prod_col[2],
                  rep(c(BH_prod_col,rev(BH_prod_col)),4))

```

```{r  fig1, echo=FALSE, fig.height = 4, fig.width = 4, fig.align = "center"}

split.screen(rbind(
c(0,1,0,1), #1
c(0.70,0.90,0.8,0.9) #2
))

screen(1)
par(mfrow=c(1,1),bty="o", mar=c(4,4,1,1))#set dimensions to plots

plot( x = spawners/1000,
      y = recruits/1000,
      ylim = c(0,max(recruits/1000)*1.1),
      xlim = c(0,max(spawners/1000)*1.1),
      ylab = "recruits (000s)",
      xlab = "spawners (000s)",
      yaxt = "n",
      pch = 16,
      cex = 1.5,
      col = time_prod_col[10:50])
axis(2,las=2)

ricker_fit <- lm(log(recruits/spawners)~spawners)
ricker_pred <- matrix(NA,100,1)
spawn <- seq(1,max(spawners),length.out=100)
for (i in 1:100){ricker_pred[i] <- exp(ricker_fit$coefficients[1])*spawn[i]*exp(ricker_fit$coefficients[2]*spawn[i]) }

points(spawn/1000,ricker_pred/1000,type="l", lwd=2)

screen(2)

par(mar=c(1,1,0,0))

legend.scale(c(0,1), 
             col = BH_prod_col,
             axis.args = list(at = c(0,1),
                              las = 1,
                              labels = c("high", "low"),
                              cex.axis = 0.55,
                              tck = 0.25,
                              padj = -3.5))

```

To do: 
- plot Kusko S-R relationship
- estimate ricker alpha and beta, plus residual error
- transform ricker alpha and beta into BH (use current assumptions about ?? to plot stationary BH)
- determine through simulation which combination of f, A and ?? most closely match RICKER SR relationship when using TV BH (determine "closely" match as linear ricker estimate of the magnitude of DD or alpha or both) could visualize as heatmap for both DD and alpha

```{r ,include=FALSE}

### NEED KUSKO SR DATA
ricker_fit <- lm(log(recruits/spawners)~spawners)
ricker_a <- ricker_fit$coefficients[1]
ricker_b <- ricker_fit$coefficients[2]

ricker_pred <- matrix(NA,100,1)
spawn <- seq(1,max(spawners),length.out=100)
for (i in 1:100){ricker_pred[i] <- exp(ricker_a )*spawn[i]*exp(ricker_b*spawn[i]) }


par(mfrow=c(1,1),bty="o", mar=c(4,4,1,1))#set dimensions to plots

plot( x = spawn/1000,
      y = ricker_pred/1000,
      type = "l",
      lwd = 2,
      ylab = "recruits (000s)",
      xlab = "spawners (000s)",
      yaxt = "n")
axis(2,las=2)

### TRANSFORM INTO time varying BH AND OVERLAY
    ricker_alpha <- exp(ricker_a)
		bh_b <- (ricker_alpha/(ricker_b*-1))*exp(-1) 
		bh_a.time <- matrix(NA,length(spawn),1)
		period <- 12
		BH.alpha.CV <- 0.4
		for (t in 1:length(spawn)){
			bh_a.time[t,] <- sin(2*pi*(t/period))*((ricker_alpha + (ricker_alpha * BH.alpha.CV)) - ricker_alpha) + ricker_alpha
		}


### USE RICKER PARAMETERS TO SIMULATE SR DATASET WITH TV BH, ESTIMATE RICKER PARAMETERS, REPEAT 100 TIMES, SAVE MEDIAN, DO FOR RANGE OF f, A and ?? AND THEN  

ricker_para_dev <- array(NA,dim=c(2,10,10,10,1000))

period <- seq(1,10)
alpha.scalar <- seq(0.2,2,length.out=10)
BH.alpha.CV <- seq(0,0.8,length.out=10)

for(w in 1:10){ 
  for(k in 1:10){
    for(j in 1:10){
      for(i in 1:1000){
            bh_sim <- sr_sim(ny = 50,
                           phi = 0,
                           rec_sd = 0.5,
                           mat = c(0.1, 0.4, 0.4, 0.1),
                           alpha = exp(ricker_a),
                           beta = (ricker_b * -1),
                           U = 0.4,
                           OU = 0.1,
                           Spw = ricker_a/(ricker_b*-1),
                           Rec = rep(ricker_a/(ricker_b*-1),8),
                           SR_rel = "Beverton-Holt",
                           period = period[k],
                           alpha.scalar = alpha.scalar[j],
                           BH.alpha.CV = BH.alpha.CV[w])
          
            spawners <- bh_sim$S[10:50]
            recruits <- bh_sim$R[10:50]
            
            ricker_fit <- lm(log(recruits/spawners)~spawners)
            ricker_para_dev[1, k, j, w, i] <- ricker_fit$coefficients[1]/ricker_a
            ricker_para_dev[2, k, j, w, i] <- ricker_fit$coefficients[2]/ricker_b
  
           }
       }
  }
} 
xx <- apply(ricker_para_dev,c(1,2,3,4),quantile,probs=c(0.5),na.rm=T)

xx[2,,,8]

period[5]
alpha.scalar[5]
BH.alpha.CV[7]


for(i in 1:100){
  bh_sim <- sr_sim(ny = 50,
                 phi = 0,
                 rec_sd = 0.5,
                 mat = c(0.1, 0.4, 0.4, 0.1),
                 alpha = exp(ricker_a),
                 beta = (ricker_b * -1),
                 U = 0.4,
                 OU = 0.1,
                 Spw = ricker_a/(ricker_b*-1),
                 Rec = rep(ricker_a/(ricker_b*-1),8),
                 SR_rel = "Beverton-Holt",
                 BH.alpha.CV = 0.4,
                 period = 3,
                 alpha.scalar = 1.5)

  spawners <- bh_sim$S[10:50]
  recruits <- bh_sim$R[10:50]
  
  ricker_fit <- lm(log(recruits/spawners)~spawners)
  ricker_para_dev[i,1] <- ricker_fit$coefficients[1]/ricker_a
  ricker_para_dev[i,2] <- ricker_fit$coefficients[2]/ricker_b

}

par(mfrow=c(1,2),bty="o", mar=c(4,4,1,1))#set dimensions to plots

hist( ricker_para_dev[,2])
hist( ricker_para_dev[,1])


```


Simulate the above 1000 times and save the alpha and beta


To do this we transformed the Ricker spawner-recruitment relationship in equation 1 to a Beverton-Holt form (Hilborn and Walters 1992) with time varying productivity: