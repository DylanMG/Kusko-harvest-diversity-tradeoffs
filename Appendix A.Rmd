---
title: 'Appendix A: Stationary Ricker to cyclical Beveton-Holt spawner-recruit formulation'
author: "B. Connors"
date: "July 23, 2019"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("load.R")
```

In our baseline simulations we assumed that recruitment dynamics are governed by stationary spawner-recruitment dynamics that follow a Ricker-type relationship with overcompensation at high spawner abundances (equations 1-3). This is the state of nature that is currently assumed by fishery managers in the Kuskokwim and widely across other salmon fisheries. We also considered an alternative recruitment hypothesis that assumed that low frequency regime shifts occur that gave rise to the appearance of overcompensation, when in fact none was present. Under this hypothesis we assumed that individual spawner-recruitment relationships were governed by Beverton-Holt dynamics with cyclical variation in population productivity (hereafter referred to as "BH_cycl"). This appendix details simulations used to parameterize the BH_cycl formulation in a manner that maintains the general system characteristics of the Kuskokwim. 

In additon to the terms in equations 1-3 there are three additoanl terms required to parameterize the BH_cyl formulation: *f* and *A* which are the period and amplitude of time varying productivity, repsecitively, and $\delta which is a scalar that adjusts productivity such that long-term population equilibrium abundance in the absence of fishing is approximately the same as those under the stationary Ricker spawner-recruitment formulation.

Here is an example of a spawner-recruit relationships generated by equation 6 with F = 12, A = 0.4 and $\delta  = 1

```{r ,include=FALSE}
# simulate a spawner-recruitment relationship assuming BH_cyl based on a draw from the posteriors of the model fit (and median alpha and beta)

sim_1 <- sr_sim(ny = 50,
                 phi = 0,
                 rec_sd = 0.3,
                 mat = c(0.15, 0.4, 0.4, 0.05),
                 alpha = exp(ricker_a),
                 beta = (ricker_b * -1),
                 U = 0.6,
                 OU = 0.1,
                 Spw = ricker_a/(ricker_b*-1),
                 Rec = rep(ricker_a/(ricker_b*-1),8),
                 SR_rel = "Beverton-Holt",
                 period = 14,
                 alpha.scalar = 1.35,
                 BH.alpha.CV = 0.6)
            
spawners <- (sim_1$S)[10:50]
recruits <- (sim_1$R)[10:50]

BH_prod_col <- viridis(7)

time_prod_col <- c(BH_prod_col[1],
                   BH_prod_col,
                   rev(BH_prod_col),
                   BH_prod_col,
                   rev(BH_prod_col),
                   BH_prod_col,
                   rev(BH_prod_col))[1:41]

rbind(sim_1$BH_prod[10:50],time_prod_col)
```

```{r  fig1, echo=FALSE, fig.height = 4, fig.width = 6, fig.align = "center"}

split.screen(rbind(
c(0,1,0,1), #1
c(0.70,0.90,0.8,0.9) #2
))

screen(1)
par(mfrow=c(1,1),bty="o", mar=c(4,4,1,1))#set dimensions to plots

plot( x = spawners/1000,
      y = recruits/1000,
      ylim = c(0,max(recruits/1000)*1.1),
      xlim = c(0,300),
      ylab = "recruits (000s)",
      xlab = "spawners (000s)",
      yaxt = "n",
      pch = 16,
      cex = 1.5,
      col = time_prod_col)
axis(2,las=2)

ricker_fit <- lm(log(recruits/spawners)~spawners)
ricker_pred <- matrix(NA,100,1)
spawn <- seq(1,300000,length.out=100)
for (i in 1:100){ricker_pred[i] <- exp(ricker_fit$coefficients[1])*spawn[i]*exp(ricker_fit$coefficients[2]*spawn[i]) }

points(spawn/1000,ricker_pred/1000,type="l", lwd=2)

screen(2)

par(mar=c(1,1,0,0))

legend.scale(c(0,1), 
             col = BH_prod_col,
             axis.args = list(at = c(0,1),
                              las = 1,
                              labels = c("low", "high"),
                              cex.axis = 0.55,
                              tck = 0.25,
                              padj = -3.5))

```

To do: 
- plot Kusko S-R relationship
- estimate ricker alpha and beta, plus residual error
- transform ricker alpha and beta into BH (use current assumptions about ?? to plot stationary BH)
- determine through simulation which combination of f, A and ?? most closely match RICKER SR relationship when using TV BH (determine "closely" match as linear ricker estimate of the magnitude of DD or alpha or both) could visualize as heatmap for both DD and alpha

```{r ,include=FALSE}

###  KUSKO SR DATA
ricker_a <- log(7.17)
ricker_b <- -0.0000098718

ricker_para_dev <- array(NA,dim=c(2,20,20,7,100))

period <- seq(1,20,length.out=20)
alpha.scalar <- seq(0.2,2,length.out=20)
BH.alpha.CV <- c(0.2,0.3,0.4,0.5,0.6,0.7,0.8)

for(w in 1:7){ 
  for(k in 1:20){
    for(j in 1:20){
      for(i in 1:100){
            bh_sim <- sr_sim(ny = 50,
                             phi = 0,
                             rec_sd = 0.2,
                             mat = c(0.15, 0.4, 0.4, 0.05),
                             alpha = exp(ricker_a),
                             beta = (ricker_b * -1),
                             U = 0.6,
                             OU = 0.1,
                             Spw = ricker_a/(ricker_b*-1),
                             Rec = rep(ricker_a/(ricker_b*-1),8),
                             SR_rel = "Beverton-Holt",
                             period = period[k],
                             alpha.scalar = alpha.scalar[j],
                             BH.alpha.CV = BH.alpha.CV[w])
          
            spawners <- bh_sim$S[10:50]
            recruits <- bh_sim$R[10:50]
            
            ricker_fit <- lm(log(recruits/spawners)~spawners)
            ricker_para_dev[1, k, j, w, i] <- ricker_fit$coefficients[1]/ricker_a
            ricker_para_dev[2, k, j, w, i] <- ricker_fit$coefficients[2]/ricker_b
  
           }
       }
  }
} 
xx <- apply(ricker_para_dev,c(1,2,3,4),quantile,probs=c(0.5),na.rm=T)

cv.0.2 <- xx[,1:20,1:20,1]
cv.0.4 <- xx[,1:20,1:20,3]
cv.0.6 <- xx[,1:20,1:20,5]
cv.0.8 <- xx[,1:20,1:20,7]
```

```{r  fig2, echo=FALSE, fig.height = 5, fig.width = 8, fig.align = "center"}

par(mfrow=c(2,3),bty="o", mar=c(2,2,2,2.5),oma=c(2,2,1,1.5))

# panel a - A = 0.2
  xx<-as.table(cv.0.2[1,,])
  colnames(xx)<-(alpha.scalar[1:20])
  rownames(xx)<-(period[1:20])
  long.data <- as.data.frame(xx)
  x <- as.numeric(paste(long.data[,1]))
  y <- as.numeric(paste(long.data[,2]))
  z <-as.numeric(long.data[,3])
  data.loess = loess(z~x*y)
  grid = expand.grid(list(x = period[1:20], y = alpha.scalar[1:20]))
  zz<-as.matrix(predict(data.loess, newdata = grid))
  xx<-alpha.scalar[1:20]
  yy<-period[1:20]
  
  image(xx,yy,zz,axes=F,ylab="",xlab="",col=rev(viridis(100)),zlim = c(0.1,1.2))
    axis(1,labels=F)
    axis(2,las=2)
    mtext(expression(paste("Ricker a ","(",italic("A"),"= 0.2)")),3,cex=0.9,line=0.5,adj=0)
  #image.plot(xx,yy,zz,axes=F,add=T,legend.mar=3,col=rev(viridis(100)),legend.width = 2, zlim = c(0.2,1.2))
    box(col="black")
  
# panel b - A = 0.4
  xx<-as.table(cv.0.4[1,,])
  colnames(xx)<-(alpha.scalar[1:20])
  rownames(xx)<-(period[1:20])
  long.data <- as.data.frame(xx)
  x <- as.numeric(paste(long.data[,1]))
  y <- as.numeric(paste(long.data[,2]))
  z <-as.numeric(long.data[,3])
  data.loess = loess(z~x*y)
  grid = expand.grid(list(x = period[1:20], y = alpha.scalar[1:20]))
  zz<-as.matrix(predict(data.loess, newdata = grid))
  xx<-alpha.scalar[1:20]
  yy<-period[1:20]
  
  image(xx,yy,zz,axes=F,ylab="",xlab="",col=rev(viridis(100)),zlim = c(0.1,1.2))
    axis(1,labels=F)
    axis(2,las=2,labels=F)
    mtext(expression(paste("Ricker a ","(",italic("A"),"= 0.4)")),3,cex=0.9,line=0.5,adj=0)
  #image.plot(xx,yy,zz,axes=F,add=T,legend.mar=3,col=rev(viridis(100)),legend.width = 2, zlim = c(0.2,1.2))
    box(col="black")
    
# panel c - A = 0.6
  xx<-as.table(cv.0.6[1,,])
  colnames(xx)<-(alpha.scalar[1:20])
  rownames(xx)<-(period[1:20])
  long.data <- as.data.frame(xx)
  x <- as.numeric(paste(long.data[,1]))
  y <- as.numeric(paste(long.data[,2]))
  z <-as.numeric(long.data[,3])
  data.loess = loess(z~x*y)
  grid = expand.grid(list(x = period[1:20], y = alpha.scalar[1:20]))
  zz<-as.matrix(predict(data.loess, newdata = grid))
  xx<-alpha.scalar[1:20]
  yy<-period[1:20]
  
  image(xx,yy,zz,axes=F,ylab="",xlab="",col=rev(viridis(100)), zlim = c(0.1,1.2))
    axis(1,labels=F)
    axis(2,las=2,labels=F)
    mtext(expression(paste("Ricker a ","(",italic("A"),"= 0.6)")),3,cex=0.9,line=0.5,adj=0)
  image.plot(xx,yy,zz,axes=F,add=T,legend.mar=3,col=rev(viridis(100)),legend.width = 2, zlim = c(0.1,1.2))
    box(col="black")


# panel d - A = 0.1
  xx<-as.table(cv.0.2[2,,])
  colnames(xx)<-(alpha.scalar[1:20])
  rownames(xx)<-(period[1:20])
  long.data <- as.data.frame(xx)
  x <- as.numeric(paste(long.data[,1]))
  y <- as.numeric(paste(long.data[,2]))
  z <-as.numeric(long.data[,3])
  data.loess = loess(z~x*y)
  grid = expand.grid(list(x = period[1:20], y = alpha.scalar[1:20]))
  zz<-as.matrix(predict(data.loess, newdata = grid))
  xx<-alpha.scalar[1:20]
  yy<-period[1:20]
  
  image(xx,yy,zz,axes=F,ylab="",xlab="",col=rev(viridis(100)), zlim = c(0.4,2))
    axis(1)
    axis(2,las=2)
    mtext(expression(paste("Ricker b ","(",italic("A"),"= 0.2)")),3,cex=0.9,line=0.5,adj=0)
  #image.plot(xx,yy,zz,axes=F,add=T,legend.mar=3,col=rev(viridis(100)),legend.width = 2, zlim = c(0.4,2))
    box(col="black")
  
# panel e - A = 0.4
  xx<-as.table(cv.0.4[2,,])
  colnames(xx)<-(alpha.scalar[1:20])
  rownames(xx)<-(period[1:20])
  long.data <- as.data.frame(xx)
  x <- as.numeric(paste(long.data[,1]))
  y <- as.numeric(paste(long.data[,2]))
  z <-as.numeric(long.data[,3])
  data.loess = loess(z~x*y)
  grid = expand.grid(list(x = period[1:20], y = alpha.scalar[1:20]))
  zz<-as.matrix(predict(data.loess, newdata = grid))
  xx<-alpha.scalar[1:20]
  yy<-period[1:20]
  
  image(xx,yy,zz,axes=F,ylab="",xlab="",col=rev(viridis(100)), zlim = c(0.4,2))
    axis(1)
    axis(2,las=2,labels=F)
    mtext(expression(paste("Ricker b ","(",italic("A"),"= 0.4)")),3,cex=0.9,line=0.5,adj=0)
  #image.plot(xx,yy,zz,axes=F,add=T,legend.mar=3,col=rev(viridis(100)),legend.width = 2, zlim = c(0.4,2))
    box(col="black")
    
# panel f - A = 0.6
  xx<-as.table(cv.0.6[2,,])
  colnames(xx)<-(alpha.scalar[1:20])
  rownames(xx)<-(period[1:20])
  long.data <- as.data.frame(xx)
  x <- as.numeric(paste(long.data[,1]))
  y <- as.numeric(paste(long.data[,2]))
  z <-as.numeric(long.data[,3])
  data.loess = loess(z~x*y)
  grid = expand.grid(list(x = period[1:20], y = alpha.scalar[1:20]))
  zz<-as.matrix(predict(data.loess, newdata = grid))
  xx<-alpha.scalar[1:20]
  yy<-period[1:20]
  
  image(xx,yy,zz,axes=F,ylab="",xlab="",col=rev(viridis(100)))
    axis(1)
    axis(2,las=2,labels=F)
    mtext(expression(paste("Ricker b ","(",italic("A"),"= 0.6)")),3,cex=0.9,line=0.5,adj=0)
  image.plot(xx,yy,zz,axes=F,add=T,legend.mar=3,col=rev(viridis(100)),legend.width = 2, zlim = c(0.4,2))
    box(col="black")


mtext(expression(paste("Alpha scalar ","(",delta,")")),1,outer=T,cex=1.1,line=1)
mtext(expression(paste("Period ","(",italic("f"),")")),side=2,outer=T,cex=1.1,line=0.4)             
```
```{r  fig3, echo=FALSE, fig.height = 4, fig.width = 9, fig.align = "center"}

ricker_a <- log(7.17)
ricker_b <- -0.0000098718

ricker_para <- array(NA,dim=c(2,100))
ricker_pred <- matrix(NA,100,100)

for(i in 1:100){
  bh_sim_1 <- sr_sim(ny = 50,
                 phi = 0,
                 rec_sd = 0.2,
                 mat = c(0.15, 0.4, 0.4, 0.05),
                 alpha = exp(ricker_a),
                 beta = (ricker_b * -1),
                 U = 0.6,
                 OU = 0.1,
                 Spw = ricker_a/(ricker_b*-1),
                 Rec = rep(ricker_a/(ricker_b*-1),8),
                 SR_rel = "Beverton-Holt",
                 period = 12,
                 alpha.scalar = 1.375,
                 BH.alpha.CV = 0.6)

  spawners <- bh_sim_1 $S[10:50]
  recruits <- bh_sim_1 $R[10:50]

  ricker_fit <- lm(log(recruits/spawners)~spawners)
  ricker_para[1,i] <- ricker_fit$coefficients[1]
  ricker_para[2,i] <- ricker_fit$coefficients[2]
  
  spawn <- seq(1,300000,length.out=100)
  for (j in 1:100){ricker_pred[i,j] <- exp(ricker_para[1,i] )*spawn[j]*exp(ricker_para[2,i]*spawn[j]) }
  
}
rec.pred <- apply(ricker_pred,c(2),quantile,probs=c(0.5),na.rm=T)
BH_prod <- bh_sim_1$BH_prod[10:50]
BH_prod_col <- viridis(7)

time_prod_col <- c(BH_prod_col[1],
                   BH_prod_col,
                   rev(BH_prod_col),
                   BH_prod_col,
                   rev(BH_prod_col),
                   BH_prod_col,
                   rev(BH_prod_col))[1:41]
rbind(BH_prod,time_prod_col)

###
ricker_pred_k <- matrix(NA,100,1)
spawn <- seq(1,300000,length.out=100)
for (i in 1:100){ricker_pred_k[i] <- exp(ricker_a )*spawn[i]*exp(ricker_b*spawn[i]) }


par(mfrow=c(1,2),bty="o", mar=c(4,4,1,1))#set dimensions to plots

# panel A
  plot( x = spawn/1000,
        y = ricker_pred_k/1000,
        type = "l",
        lwd = 2,
        ylab = "recruits (000s)",
        xlab = "spawners (000s)",
        yaxt = "n",
        ylim = c(0,350))
  axis(2,las=2)
  box(col="grey")
  
  points(spawn/1000,
         rec.pred/1000,
         type="l",
         col="red",
         lwd=2)
  
  legend(100,370,
         c("Ricker","Time-varying Beverton-Holt"),
         lwd=2,
         col=c("black","red"),
         cex=0.8, 
         bty="n")

# panel B
  plot( x = seq(10:50),
        y = BH_prod,
        type = "l",
        lwd = 2,
        ylab = "productivity",
        xlab = "time",
        yaxt = "n",
        col="grey",
        ylim=c(1,17))
  
  axis(2,las=2)
  box(col="grey")
  
  points(seq(10:50),
         BH_prod,
         col=time_prod_col,
         pch=16)

```